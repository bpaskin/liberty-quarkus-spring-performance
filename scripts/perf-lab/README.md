# Benchmarks

This is the main entrypoint for running benchmarks.

> [!IMPORTANT]
> Please read the [Running performance comparisons documentation](../../README.md#running-performance-comparisons)!!! This is super important to understand how benchmarks work!

Now that you've read that (if you haven't, please go do so now) here's the details on how to run on a single machine, with solid automation and detailed reporting.

The main tool for scripting the automation is [qDup](https://github.com/Hyperfoil/qDup). qDup supports running on the local machine as well as on a remote host.

The [`main.yml`](main.yml) file is the main entrypoint for qDup. It defines the sequence of steps to run and ensures all the required tools are installed on the host the benchmark is being run on.

> [!NOTE]
> This is also the same benchmark we run in our controlled performance lab environment. We have dedicated hardware for this purpose.

The main entrypoint is the `run-benchmarks.sh` script. This script has many options that can be passed in. Run `./run-benchmarks.sh -h` to see them all.

> [!TIP]
> This automation currently supports Linux and macOS hosts. Running on Windows Subsystem for Linux (WSL) has not been tested. Running on Windows directly is not supported.
> 
> ALSO - it only supports `bash` shell on both local & remote hosts.

The script also has 3 dependencies that need to be resolved before it can be run:
- [git](https://github.com/git-guides/install-git)
- [jbang](https://www.jbang.dev/download)
- [jq](https://stedolan.github.io/jq)
- bash shell

> [!IMPORTANT]
> There are several requirements to run the benchmarks:
> 1. The host must have `bash` shell installed.
> 2. If running on a remote host, the ssh connection to the remote host must be configured to allow [passwordless login](https://www.strongdm.com/blog/ssh-passwordless-login).
> 3. If running on Linux, the user on the host (local or remote) must have [passwordless sudo privileges](https://unix.stackexchange.com/questions/468416/setting-up-passwordless-sudo-on-linux-distributions).
>     - If this isn't an option, then the host must have the following software installed (see [requirements.yml](helpers/requirements.yml) for details):
>         - [SDKMAN!](https://sdkman.io/)
>             - `sdk i java <-j flag passed to the script>`
>             - `sdk i java <-g flag passed to the script>`
>             - `export GRAALVM_HOME=$(sdk home java <-g flag passed to the script>)`
>         - [git](https://github.com/git-guides/install-git)
>         - [jbang](https://www.jbang.dev/download)
>         - [jq](https://stedolan.github.io/jq)
>         - gcc
>         - [NVM](https://github.com/nvm-sh/nvm/blob/master/README.md)
>             - `nvm install --lts`
>             - `nvm use --lts`

## Usage

```bash
./run-benchmarks.sh [options]
```

### Options

| Option                           | Parameter                     | Description                                                                                                                                                                                                             | Default                                                                                                              |
|----------------------------------|-------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------|
| `--cpus`                         | `<CPUS>`                      | How many CPUs to allocate to the application                                                                                                                                                                            | `4`                                                                                                                  |
| `--drop-fs-caches`               |                               | Purge/drop OS filesystem caches between iterations                                                                                                                                                                      |                                                                                                                      |
| `--extra-qdup-args`              | `<EXTRA_QDUP_ARGS>`           | Any extra arguments that need to be passed to qDup ahead of the qDup scripts<br/>**NOTE:** This is an advanced option. Make sure you know what you are doing when using it.                                             |                                                                                                                      |
| `--graalvm-version`              | `<GRAALVM_VERSION>`           | The GraalVM version to use if running any native tests (from SDKMAN)                                                                                                                                                    | `25.0.1-graalce`                                                                                                     |
| `--host`                         | `<HOST>`                      | The HOST to run the benchmarks on<br/>`LOCAL` is a keyword that can be used to run everything on the local machine                                                                                                      | `LOCAL`                                                                                                              |
| `--iterations`                   | `<ITERATIONS>`                | The number of iterations to run each test                                                                                                                                                                               | `3`                                                                                                                  |
| `--java-version`                 | `<JAVA_VERSION>`              | The Java version to use (from SDKMAN)                                                                                                                                                                                   | `25.0.1-tem`                                                                                                         |
| `--jvm-args`                     | `<JVM_ARGS>`                  | Any runtime JVM args to be passed to the apps                                                                                                                                                                           |                                                                                                                      |
| `--jvm-memory`                   | `<JVM_MEMORY>`                | JVM Memory setting (i.e. -Xmx -Xmn -Xms)                                                                                                                                                                                |                                                                                                                      |
| `--native-quarkus-build-options` | `<NATIVE_QUARKUS_OPTS>`       | Native build options to be passed to Quarkus native build process                                                                                                                                                       |                                                                                                                      |
| `--native-spring3-build-options` | `<NATIVE_SPRING3_OPTS>`       | Native build options to be passed to Spring 3.x native build process                                                                                                                                                    |                                                                                                                      |
| `--native-spring4-build-options` | `<NATIVE_SPRING4_OPTS>`       | Native build options to be passed to Spring 4.x native build process                                                                                                                                                    |                                                                                                                      |
| `--output-dir`                   | `<OUTPUT_DIR>`                | The directory containing the run output                                                                                                                                                                                 | `/tmp`                                                                                                               |
| `--profiler`                     | `<PROFILER>`                  | Enable profiling with async profiler<br/>Accepted values: `none`, `jfr`, `flamegraph`                                                                                                                                   | `none`                                                                                                               |
| `--quarkus-build-config-args`    | `<QUARKUS_BUILD_CONFIG_ARGS>` | Quarkus app configuration properties fixed at build time                                                                                                                                                                |                                                                                                                      |
| `--quarkus-version`              | `<QUARKUS_VERSION>`           | The Quarkus version to use<br/>**NOTE:** Its a good practice to set this manually to ensure proper version                                                                                                              | Whatever version is set in pom.xml of the Quarkus app                                                                |
| `--repo-branch`                  | `<SCM_REPO_BRANCH>`           | The branch in the SCM repo                                                                                                                                                                                              | `main`                                                                                                               |
| `--repo-url`                     | `<SCM_REPO_URL>`              | The SCM repo url                                                                                                                                                                                                        | `https://github.com/quarkusio/spring-quarkus-perf-comparison.git`                                                    |
| `--runtimes`                     | `<RUNTIMES>`                  | The runtimes to test, separated by commas<br/>Accepted values (1 or more of): `quarkus3-jvm`, `quarkus3-native`, `spring3-jvm`, `spring3-jvm-aot`, `spring3-native`, `spring4-jvm`, `spring4-jvm-aot`, `spring4-native` | `quarkus3-jvm,quarkus3-native,spring3-jvm,spring3-jvm-aot,spring3-native,spring4-jvm,spring4-jvm-aot,spring4-native` |
| `--springboot3-version`          | `<SPRING_BOOT3_VERSION>`      | The Spring Boot 3.x version to use<br/>**NOTE:** Its a good practice to set this manually to ensure proper version                                                                                                      | Whatever version is set in pom.xml of the Spring Boot 3 app                                                          |
| `--springboot4-version`          | `<SPRING_BOOT4_VERSION>`      | The Spring Boot 4.x version to use<br/>**NOTE:** Its a good practice to set this manually to ensure proper version                                                                                                      | Whatever version is set in pom.xml of the Spring Boot 4 app                                                          |
| `--tests`                        | `<TESTS_TO_RUN>`              | The tests to run, separated by commas<br/>Accepted values (1 or more of): `test-build`, `measure-build-times`, `measure-time-to-first-request`, `measure-rss`, `run-load-test`                                          | `test-build,measure-build-times,measure-time-to-first-request,measure-rss,run-load-test`                             |
| `--user`                         | `<USER>`                      | The user on `<HOST>` to run the benchmark                                                                                                                                                                               |                                                                                                                      |
| `--wait-time`                    | `<WAIT_TIME>`                 | Wait time (in seconds) to wait for things like application startup                                                                                                                                                      | `20`                                                                                                                 |

### Available Runtimes

The `-r` option accepts one or more of the following values (comma-separated):

- `quarkus3-jvm` - [Quarkus 3](../../quarkus3) on JVM
- `quarkus3-native` - [Quarkus 3](../../quarkus3) native executable
- `spring4-jvm` - [Spring Boot 4](../../springboot4) on JVM
- `spring4-jvm-aot` - [Spring Boot 3](../../springboot4) on JVM with AOT compilation
- `spring4-native` - [Spring Boot 3](../../springboot4) native executable
- `spring3-jvm` - [Spring Boot 3](../../springboot3) on JVM
- `spring3-jvm-aot` - [Spring Boot 3](../../springboot3) on JVM with AOT compilation
- `spring3-native` - [Spring Boot 3](../../springboot3) native executable

**Default:** All runtimes are tested

### Available Tests

The `-t` option accepts one or more of the following values (comma-separated):

| Test Name                       | Description                                                               | Notes                                                                                                                                                                                   |
|---------------------------------|---------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `test-build`                    | Verifies that the applications build successfully                         | There aren't any actual metrics reported for this test                                                                                                                                  |
| `measure-build-times`           | Measure application build times                                           | `Build RSS`, `# of classes/fields/methods`, and `# of classes/fields/methods using reflection` are also calculated if any of the [`native` runtimes](#available-runtimes) are selected. |
| `measure-time-to-first-request` | Measure startup time to first request                                     |                                                                                                                                                                                         |
| `measure-rss`                   | Measure Resident Set Size (memory usage) at startup and after 1st request |                                                                                                                                                                                         |
| `run-load-test`                 | Run load testing scenarios                                                | Calculates max throughput, peak RSS, and throughput density (i.e. at max throughput, how many req/sec per MB of memory needed for capacity planning)                                    |

**Default:** All tests are executed

## Output
The output of the run will be a bunch of files, whose location will be output at the end of the run:

```shell
09:14:14.985 run-1761051869844 downloading queued downloads
09:14:14.985 Local.download(hyperfoil@deathstar:22:/tmp/metrics.json,/tmp/20251021_090429/target-host/)
09:14:15.375 Local.download(hyperfoil@deathstar:22:/home/hyperfoil/spring-quarkus-perf-comparison/logs/*,/tmp/20251021_090429/target-host/)
Finished in 09:44.800 at /tmp/20251021_090429 
```

If you examine the output directory:

```shell
├── run.json
├── run.log
└── target-host
    ├── build-times-quarkus3-jvm-0.log
    ├── build-times-quarkus3-jvm-1.log
    ├── build-times-quarkus3-jvm-2.log
    ├── build-times-quarkus3-native-0.log
    ├── build-times-quarkus3-native-1.log
    ├── build-times-quarkus3-native-2.log
    ├── build-times-spring3-jvm-0.log
    ├── build-times-spring3-jvm-1.log
    ├── build-times-spring3-jvm-2.log
    ├── build-times-spring3-jvm-aot-0.log
    ├── build-times-spring3-jvm-aot-1.log
    ├── build-times-spring3-jvm-aot-2.log
    ├── build-times-spring3-native-0.log
    ├── build-times-spring3-native-1.log
    ├── build-times-spring3-native-2.log
    └── <potentially more .log files based on which tests were run>
    └── metrics.json
```

- The `run.json` file contains the run metadata.
- The `run.log` file contains the full run log.
- All of the `target-host/*.log` files contain the output from the individual tests.
- The `target-host/metrics.json` file contains all the recorded metrics.

## Examples
### Basic Local Benchmark

Runs [all the tests](#available-tests) against [all the runtimes](#available-runtimes) using Quarkus version `3.28.4` and Spring Boot version `3.5.6`.

```shell
./run-benchmarks.sh --quarkus-version 3.28.4 --springboot3-version 3.5.6
```

### JVM tests only

Runs [all the tests](#available-tests) only the JVM runtimes using Quarkus version `3.30.5` and Spring Boot versions `3.5.9` & `4.0.1`.

```shell
./run-benchmarks.sh --quarkus-version 3.30.5 --springboot3-version 3.5.9 --springboot4-version 4.0.1 --runtimes 'quarkus3-jvm,spring4-jvm,spring3-jvm'
```

### Run all the benchmarks on a remote host from a different fork

Runs [all the tests](#available-tests) against [all the runtimes](#available-runtimes) using Quarkus version `3.28.4` and Spring Boot version `3.5.6` on a remote host, while pulling the benchmarks from the `open-benchmarks` branch on the https://github.com/edeandrea/spring-quarkus-perf-comparison.git repo, and running 5 iterations of each test.

```shell
 ./run-benchmarks.sh \
    --user <REMOTE_USER> \
    --host <REMOTE_HOST> \
    --quarkus-version 3.28.4 \
    --springboot3-version 3.5.6 \
    --tests 'measure-build-times,measure-time-to-first-request,measure-rss,run-load-test' \
    --runtimes 'quarkus3-jvm,quarkus3-native,spring4-jvm,spring4-jvm-aot,spring4-native,spring3-jvm,spring3-jvm-aot,spring3-native' \
    --iterations 5 \
    --repo-url https://github.com/<some_user>/spring-quarkus-perf-comparison.git \
    --repo-branch another-branch \
    --drop-fs-caches
```


## Notes

- **Version Specification:** It is strongly recommended to explicitly set the Quarkus and Spring Boot versions to ensure consistent and reproducible benchmarks.
- **Remote Execution:** When using a HOST other than `LOCAL`, the `--user` (USER) parameter is required.
- **Resource Constraints:** The `--cpus` (CPU constraints) and `--jvm-memory` (memory constraints) options use cgroups to limit resources available to the benchmarked applications.
- **Profiling:** When profiling is enabled, async profiler will be used to generate JFR files or flamegraphs depending on the selected option.

## Exit Codes

- **0** - Successful execution
- **1** - Error occurred (missing required parameters, invalid options, etc.)
